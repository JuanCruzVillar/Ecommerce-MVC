@using eCommerce.Entities
@model IEnumerable<Producto>

@{
    ViewData["Title"] = "Productos";
}

<h1>Productos</h1>

<p>
    <a asp-action="Create" class="btn btn-primary mb-2">
        <i class="bi bi-plus-circle"></i> Crear Nuevo
    </a>
</p>

<div class="table-responsive table-responsive-sm">
    <table id="productosTable" class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th style="width:70px;">Imagen</th>
                <th>@Html.DisplayNameFor(m => m.Nombre)</th>
                <th>@Html.DisplayNameFor(m => m.Descripcion)</th>
                <th>@Html.DisplayNameFor(m => m.Precio)</th>
                <th>@Html.DisplayNameFor(m => m.Stock)</th>
                <th style="width:60px;">Activo</th>
                <th>@Html.DisplayNameFor(m => m.FechaRegistro)</th>
                <th>Categoría</th>
                <th>Subcategoría</th> 
                <th>@Html.DisplayNameFor(m => m.IdMarcaNavigation)</th>
                <th style="width:150px;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(item.RutaImagen))
                        {
                            <img src="@item.RutaImagen" alt="@item.Nombre" class="img-thumbnail" style="max-width:60px;" />
                        }
                    </td>
                    <td>@item.Nombre</td>
                    <td>@(item.Descripcion?.Length > 50 ? item.Descripcion.Substring(0, 50) + "..." : item.Descripcion)</td>
                    <td>@string.Format("${0:N2}", item.Precio)</td>
                    <td>@item.Stock</td>
                    <td class="text-center">
                        @if (item.Activo == true)
                        {
                            <i class="bi bi-check-circle-fill text-success" title="Activo"></i>
                        }
                        else
                        {
                            <i class="bi bi-x-circle-fill text-danger" title="Inactivo"></i>
                        }
                </td>
                <td>@item.FechaRegistro?.ToString("dd/MM/yyyy HH:mm")</td>

                <!-- Columna Categoría -->
                <td>
                    @(item.IdCategoriaNavigation?.CategoriaPadre != null
                                        ? item.IdCategoriaNavigation.CategoriaPadre.Descripcion
                                        : item.IdCategoriaNavigation?.Descripcion ?? "—")
                                                                                     </td>

                <!-- Columna Subcategoría -->
                <td>
                    @(item.IdCategoriaNavigation?.CategoriaPadre != null
                                        ? item.IdCategoriaNavigation.Descripcion
                                        : "—")
                </td>


                    <td>@item.IdMarcaNavigation?.Descripcion</td>
                    <td class="text-nowrap">
                        <a asp-action="Edit" asp-route-id="@item.IdProducto" class="btn btn-warning me-1" data-bs-toggle="tooltip" title="Editar">
                            <i class="bi bi-pencil-fill"></i>
                        </a>
                        <a asp-action="Details" asp-route-id="@item.IdProducto" class="btn btn-info me-1 text-white" data-bs-toggle="tooltip" title="Ver Detalles">
                            <i class="bi bi-eye-fill"></i>
                        </a>
                        <form asp-area="Admin" asp-controller="Productos" asp-action="DeleteConfirmed" asp-route-id="@item.IdProducto" method="post" class="d-inline form-eliminar">
                            <button type="submit" class="btn btn-danger" data-bs-toggle="tooltip" title="Eliminar">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                        }
        </tbody>

    </table>

</div>

@section Scripts {
    <!-- jQuery y DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- Botones de exportación -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            // Inicializar DataTables
            $('#productosTable').DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                ordering: true,
                info: true,
                autoWidth: false,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                },
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
            });

            // Tooltips Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Alertas SweetAlert desde TempData
            @if (TempData["Success"] != null)
            {
                    <text>
                        Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: '@TempData["Success"]'
                        });
                    </text>
            }
            @if (TempData["Error"] != null)
            {
                    <text>
                        Swal.fire({
                            icon: 'error',
                            title: '¡Error!',
                            text: '@TempData["Error"]'
                        });
                    </text>
            }

            // Confirmación SweetAlert al eliminar
            const forms = document.querySelectorAll('.form-eliminar');
            forms.forEach(form => {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    Swal.fire({
                        title: '¿Está seguro?',
                        text: "No podrá revertir esta acción",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                });
            });
        });
    </script>
}
