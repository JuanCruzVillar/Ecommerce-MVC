<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Hardware Store</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/styles.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }

        .navbar-main {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 0.8rem 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .navbar-secondary {
            background: white;
            border-top: 3px solid var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding: 1rem 0;
        }

            .navbar-secondary .nav-link {
                color: #333 !important;
                font-weight: 500;
                transition: all 0.3s ease;
                position: relative;
            }

                .navbar-secondary .nav-link:hover {
                    color: var(--primary-color) !important;
                }

                .navbar-secondary .nav-link::after {
                    content: '';
                    position: absolute;
                    bottom: -8px;
                    left: 0;
                    width: 0;
                    height: 3px;
                    background: var(--primary-gradient);
                    transition: width 0.3s ease;
                }

                .navbar-secondary .nav-link:hover::after {
                    width: 100%;
                }

        .btn-auth {
            background: var(--primary-gradient);
            border: none;
            color: white !important;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

            .btn-auth:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

        .btn-carrito {
            background: var(--primary-gradient);
            border: none;
            color: white !important;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

            .btn-carrito:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

        #carrito-badge {
            background: var(--secondary-color) !important;
            font-size: 0.7rem;
            min-width: 24px;
        }

        .input-group .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 8px 0 0 8px;
            transition: all 0.3s ease;
        }

            .input-group .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: none;
            }

        .input-group .btn {
            background: var(--primary-color);
            color: white;
            border: 2px solid var(--primary-color);
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }

            .input-group .btn:hover {
                background: var(--secondary-color);
                border-color: var(--secondary-color);
            }

        #navbarSugerencias .list-group-item {
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            border-bottom: 1px solid #f0f0f0;
        }

            #navbarSugerencias .list-group-item:hover {
                background-color: #f8f9ff;
                border-left: 4px solid var(--primary-color);
            }

        #navbarSugerencias {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            border-top: 3px solid var(--primary-color);
        }

            .dropdown-menu .dropdown-item {
                transition: all 0.2s ease;
            }

                .dropdown-menu .dropdown-item:hover {
                    background-color: #f8f9ff;
                    color: var(--primary-color);
                    padding-left: 1.75rem;
                }

        #userDropdown {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        footer {
            background: var(--primary-gradient);
            margin-top: auto;
        }

        .transition-link {
            transition: color 0.3s ease;
        }

            .transition-link:hover {
                color: #ffffff !important;
            }

        .btn-light:hover {
            background-color: rgba(255, 255, 255, 0.8) !important;
            transform: translateY(-2px);
        }

        @@media (max-width: 768px) {
            footer .row > div {
                margin-bottom: 2rem;
            }

            footer h6 {
                font-size: 1rem;
            }

            .navbar-secondary .nav-link::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-main">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="@Url.Action("Index", "Catalogo", new { area = "Negocio" })">
                <i class="bi bi-laptop"></i> Hardware Store
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <form class="d-flex me-3 position-relative" style="flex: 1; max-width: 500px;" method="get"
                      asp-area="Negocio" asp-controller="Catalogo" asp-action="Index">
                    <div class="input-group w-100">
                        <input class="form-control" type="search" name="busqueda" id="navbarBusqueda"
                               placeholder="Buscar productos..." aria-label="Buscar">
                        <button class="btn" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <div id="navbarSugerencias" class="list-group position-absolute w-100"
                         style="top: 100%; z-index: 1050; display: none; max-height: 400px; overflow-y: auto;"></div>
                </form>

                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-1"></i>@User.Identity.Name
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("Index", "Perfil", new { area = "Negocio" })">
                                        <i class="bi bi-person me-2"></i>Mi Perfil
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("MisCompras", "Perfil", new { area = "Negocio" })">
                                        <i class="bi bi-bag-check me-2"></i>Mis Compras
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("MisDirecciones", "Perfil", new { area = "Negocio" })">
                                        <i class="bi bi-geo-alt me-2"></i>Mis Direcciones
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("Logout", "Auth", new { area = "Negocio" })" id="logoutLink">
                                        <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
                                    </a>
                                </li>
                            </ul>
                        </li>
                    }
                    else
                    {
                        <li class="nav-item d-flex align-items-center">
                            <a class="btn-auth" href="@Url.Action("Login", "Auth", new { area = "Negocio" })">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Iniciar Sesión
                            </a>
                        </li>
                    }

                    <li class="nav-item ms-2 d-flex align-items-center">
                        <a class="btn-carrito" href="@Url.Action("Index", "Carrito", new { area = "Negocio" })">
                            <i class="bi bi-cart-fill"></i> Carrito
                            <span id="carrito-badge" class="badge rounded-pill ms-1">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <nav class="navbar-secondary">
        <div class="container">
            <ul class="nav justify-content-center">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="dropdownProductos"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-boxes me-1"></i>Productos
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="dropdownProductos">
                        @await Component.InvokeAsync("CategoriasMenu")
                    </ul>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="@Url.Action("Index", "ArmatuPc", new { area = "Negocio" })">
                        <i class="bi bi-tools me-1"></i>Arma tu PC
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="@Url.Action("Index", "Ofertas", new { area = "Negocio" })">
                        <i class="bi bi-tags me-1"></i>Ofertas
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/Negocio/Ayuda">
                        <i class="bi bi-question-circle me-1"></i>Ayuda
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid px-0">
        @RenderBody()
    </div>

    <footer class="mt-5">
        <div class="container py-5">
            <div class="row g-4 mb-5">
                <div class="col-md-3 col-sm-6">
                    <h5 class="fw-bold text-white mb-3">
                        <i class="bi bi-laptop me-2"></i>Hardware Store
                    </h5>
                    <p class="text-white-50 small mb-3">
                        Tu tienda de confianza para componentes y equipos de computación de calidad.
                    </p>
                    <div class="d-flex gap-2">
                        <a href="https://facebook.com" class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-facebook"></i>
                        </a>
                        <a href="https://twitter.com" class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-twitter"></i>
                        </a>
                        <a href="https://instagram.com" class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-instagram"></i>
                        </a>
                        <a href="https://youtube.com" class="btn btn-light btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-youtube"></i>
                        </a>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <h6 class="fw-bold text-white mb-3">
                        <i class="bi bi-link-45deg me-2"></i>Enlaces Útiles
                    </h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="#" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Catálogo
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Arma tu PC
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Ofertas
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/Negocio/Ayuda" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Centro de Ayuda
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <h6 class="fw-bold text-white mb-3">
                        <i class="bi bi-truck me-2"></i>Compra y Envío
                    </h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="/Negocio/Ayuda#envios" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Información de Envíos
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/Negocio/Ayuda#devoluciones" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Devoluciones
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/Negocio/Ayuda#garantias" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Garantías
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/Negocio/Ayuda#preguntas-frecuentes" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-chevron-right"></i> Preguntas Frecuentes
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-md-3 col-sm-6">
                    <h6 class="fw-bold text-white mb-3">
                        <i class="bi bi-telephone me-2"></i>Contacto
                    </h6>
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <div class="text-white-50 small">
                                <i class="bi bi-geo-alt me-2"></i>
                                <span>Bahía Blanca, Buenos Aires</span>
                            </div>
                        </li>
                        <li class="mb-3">
                            <a href="tel:+5429112345679" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-telephone me-2"></i>
                                <span>+54 291 123-4567</span>
                            </a>
                        </li>
                        <li class="mb-3">
                            <a href="mailto:info@hardwarestore.com" class="text-white-50 text-decoration-none transition-link">
                                <i class="bi bi-envelope me-2"></i>
                                <span>info@hardwarestore.com</span>
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="https://wa.me/5492911234567" target="_blank" class="btn btn-success btn-sm">
                                <i class="bi bi-whatsapp me-1"></i>WhatsApp
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <hr class="bg-white-50">

            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <p class="text-white-50 small mb-0">
                        &copy; 2025 Hardware Store. Todos los derechos reservados.
                    </p>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2 justify-content-md-end">
                        <a href="#" class="text-white-50 text-decoration-none small transition-link">Términos y Condiciones</a>
                        <span class="text-white-50">|</span>
                        <a href="#" class="text-white-50 text-decoration-none small transition-link">Política de Privacidad</a>
                        <span class="text-white-50">|</span>
                        <a href="#" class="text-white-50 text-decoration-none small transition-link">Cookies</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const CarritoLS = {
            STORAGE_KEY: 'carrito_hardware_store',

            obtener: function() {
                try {
                    const carrito = localStorage.getItem(this.STORAGE_KEY);
                    return carrito ? JSON.parse(carrito) : [];
                } catch (error) {
                    console.error('Error al obtener carrito:', error);
                    return [];
                }
            },

            guardar: function(carrito) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(carrito));
                    this.actualizarBadge();
                } catch (error) {
                    console.error('Error al guardar carrito:', error);
                }
            },

            agregar: function(productoId, cantidad = 1) {
                const carrito = this.obtener();
                const itemExistente = carrito.find(item => item.idProducto === productoId);

                if (itemExistente) {
                    itemExistente.cantidad += cantidad;
                } else {
                    carrito.push({ idProducto: productoId, cantidad: cantidad });
                }

                this.guardar(carrito);
            },

            eliminar: function(productoId) {
                let carrito = this.obtener();
                carrito = carrito.filter(item => item.idProducto !== productoId);
                this.guardar(carrito);
            },

            vaciar: function() {
                localStorage.removeItem(this.STORAGE_KEY);
                this.actualizarBadge();
            },

            cantidadTotal: function() {
                const carrito = this.obtener();
                return carrito.reduce((total, item) => total + item.cantidad, 0);
            },

            actualizarBadge: function() {
                const userAuth = @(User.Identity.IsAuthenticated ? "true" : "false");

                if (userAuth) {
                    $.get('/Negocio/Carrito/Cantidad', function(total) {
                        $('#carrito-badge').text(total);
                    }).fail(function() {
                        $('#carrito-badge').text('0');
                    });
                } else {
                    const cantidad = CarritoLS.cantidadTotal();
                    $('#carrito-badge').text(cantidad);
                }
            },

            migrarAServidor: function() {
                const carrito = this.obtener();
                if (carrito.length === 0) return;

                console.log('🔄 Migrando carrito al servidor...', carrito);

                $.ajax({
                    type: 'POST',
                    url: '/Negocio/Carrito/MigrarCarrito',
                    contentType: 'application/json',
                    data: JSON.stringify(carrito.map(item => ({
                        idProducto: item.idProducto,
                        cantidad: item.cantidad
                    }))),
                    success: function(response) {
                        if (response.success) {
                            CarritoLS.vaciar();
                            CarritoLS.actualizarBadge();
                            console.log('✅ Carrito migrado exitosamente');

                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'Carrito actualizado',
                                showConfirmButton: false,
                                timer: 2000
                            });
                        }
                    },
                    error: function(error) {
                        console.error('❌ Error al migrar carrito:', error);
                    }
                });
            }
        };

               $(document).ready(function() {
            const userAuth = @(User.Identity.IsAuthenticated ? "true" : "false");

            CarritoLS.actualizarBadge();

            if (userAuth) {
                setInterval(function() {
                    CarritoLS.actualizarBadge();
                }, 30000);
            }

            const acabaDeLogear = sessionStorage.getItem('recien_logeado');
            if (acabaDeLogear === 'true' && userAuth) {
                sessionStorage.removeItem('recien_logeado');
                setTimeout(function() {
                    CarritoLS.migrarAServidor();
                }, 500);
            }

            // AGREGAR AL CARRITO
            $(document).on('click', '.agregar-carrito', function(e) {
                e.preventDefault();

                const productoId = parseInt($(this).data('producto'));
                const boton = $(this);
                const textoOriginal = boton.html();

                if (!productoId) {
                    console.error('ID de producto inválido');
                    return;
                }

                boton.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Agregando...');

                $.ajax({
                    type: 'POST',
                    url: '/Negocio/Carrito/Agregar',
                    data: {
                        productoId: productoId,
                        cantidad: 1
                    },
                    success: function(response) {
                        if (response.success) {
                            if (response.sinSesion) {
                                CarritoLS.agregar(productoId, 1);
                            }

                            CarritoLS.actualizarBadge();

                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: 'Agregado al carrito',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message || 'No se pudo agregar el producto',
                                confirmButtonColor: '#667eea'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error de conexión',
                            confirmButtonColor: '#667eea'
                        });
                    },
                    complete: function() {
                        boton.prop('disabled', false).html(textoOriginal);
                    }
                });
            });

            // ========== BÚSQUEDA CON SUGERENCIAS ==========
            let timeoutId;

            console.log('🔧 Inicializando buscador...');
            console.log('📍 Input existe:', $('#navbarBusqueda').length > 0);

            $('#navbarBusqueda').on('keyup', function(e) {
                console.log('🔍 Keyup detectado, tecla:', e.key);

                if (e.key === 'Enter') return;

                clearTimeout(timeoutId);
                const termino = $(this).val();
                console.log('📝 Término:', termino, '(largo:', termino.length + ')');

                if (termino.length < 2) {
                    console.log('⚠️ Término muy corto');
                    $('#navbarSugerencias').hide().empty();
                    return;
                }

                console.log('⏳ Esperando 300ms...');

                timeoutId = setTimeout(function() {
                    console.log('🚀 Enviando petición AJAX...');

                    $.ajax({
                        url: '/Negocio/Catalogo/BuscarAjax',
                        type: 'GET',
                        data: { termino: termino },
                        success: function(data) {
                            console.log('✅ Respuesta:', data);

                            if (data.success && data.resultados.length > 0) {
                                console.log('📦 Mostrando', data.resultados.length, 'resultados');
                                let html = '';
                                data.resultados.forEach(function(p) {
                                    const urlDetalle = '/Negocio/Catalogo/Detalle?id=' + p.id;

                                    html += `
                                        <a href="${urlDetalle}" class="list-group-item list-group-item-action bg-white">
                                            <div class="d-flex align-items-center">
                                                <img src="${p.imagen || 'https://dummyimage.com/50x50/dee2e6/6c757d.jpg'}"
                                                     class="me-2 rounded" style="width:50px;height:50px;object-fit:cover;">
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold">${p.nombre}</div>
                                                    <small class="text-success fw-bold">$${p.precio}</small>
                                                </div>
                                            </div>
                                        </a>
                                    `;
                                });
                                $('#navbarSugerencias').html(html).show();
                                console.log('✅ Dropdown mostrado');
                            } else {
                                console.log('⚠️ Sin resultados o error:', data.message);
                                $('#navbarSugerencias').hide().empty();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('❌ Error AJAX:', error);
                            console.error('❌ Status:', xhr.status);
                            console.error('❌ Response:', xhr.responseText);
                            $('#navbarSugerencias').hide().empty();
                        }
                    });
                }, 300);
            });

            $(document).on('click', function(e) {
                if (!$(e.target).closest('#navbarBusqueda, #navbarSugerencias').length) {
                    $('#navbarSugerencias').hide();
                }
            });

            $('#navbarBusqueda').on('focus', function() {
                if ($(this).val().length >= 2 && $('#navbarSugerencias').children().length > 0) {
                    $('#navbarSugerencias').show();
                }
            });

            console.log('✅ Buscador inicializado correctamente');
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>