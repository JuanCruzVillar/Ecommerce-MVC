@model IEnumerable<eCommerce.Entities.ViewModels.CarritoViewModel>

@{
    Layout = "~/Areas/Negocio/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Carrito de Compras";
}

<div class="container py-5">
    <h2 class="fw-bolder mb-4">Tu Carrito</h2>

    <div class="table-responsive" id="carrito-container" @(Model.Any() ? "" : "style='display:none;'")>
        <table class="table table-bordered align-middle text-center" id="carrito-table">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="carrito-body">
                @foreach (var item in Model)
                {
                    <tr data-producto="@item.IdProducto">
                        <td class="text-start">
                            <img src="@(item.RutaImagen ?? "https://dummyimage.com/80x80/dee2e6/6c757d.jpg")"
                                 alt="@item.Nombre" class="img-thumbnail me-2" style="width:80px; height:80px; object-fit:cover;">
                            @item.Nombre
                        </td>
                        <td>$@item.Precio?.ToString("N2")</td>
                        <td>@item.Cantidad</td>
                        <td class="subtotal">$@item.Subtotal.ToString("N2")</td>
                        <td>
                            <button class="btn btn-danger btn-sm eliminar-producto">Eliminar</button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="text-end">Total:</th>
                    <th id="total">$0.00</th>
                    <th>
                        <button id="vaciar-carrito" class="btn btn-warning btn-sm">Vaciar carrito</button>
                    </th>
                </tr>
            </tfoot>
        </table>

        <div class="mt-3">
            @Html.ActionLink("Finalizar Compra", "Index", "Checkout", new { area = "Negocio" }, new { @class = "btn btn-success" })
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function(){

            function parseARNumber(str){
                return parseFloat(str.replace(/\./g,'').replace(',', '.')) || 0;
            }

            function actualizarTotal(){
                let total = 0;
                $('#carrito-body tr').each(function(){
                    let subtotalStr = $(this).find('.subtotal').text().replace('$','').trim();
                    let subtotal = parseARNumber(subtotalStr);
                    total += subtotal;
                });
                $('#total').text('$' + total.toLocaleString('es-AR', {minimumFractionDigits:2}));
            }

            function actualizarBadge(){
                $.get('@Url.Action("Cantidad", "Carrito", new { area = "Negocio" })', function(total){
                    $('#carrito-badge').text(total);
                });
            }

            
            function actualizarVistaCarrito(){
                if($('#carrito-body tr').length === 0){
                    $('#carrito-container').hide();
                    if($('#carrito-vacio').length === 0){
                        $('.container.py-5').append(`
                            <div id="carrito-vacio">
                                <div class="alert alert-info mt-3">Tu carrito está vacío.</div>
                                <a href='@Url.Action("Index", "Catalogo", new { area = "Negocio" })' class="btn btn-primary mt-2">Agregar Productos</a>
                            </div>
                        `);
                    }
                }
            }

            actualizarTotal();
            actualizarBadge();
            actualizarVistaCarrito();

            $('.eliminar-producto').click(function(){
                let row = $(this).closest('tr');
                let productoId = row.data('producto');

                Swal.fire({
                    title:'Eliminar producto',
                    text:'¿Deseas eliminar este producto del carrito?',
                    icon:'warning',
                    showCancelButton:true,
                    confirmButtonText:'Sí',
                    cancelButtonText:'Cancelar'
                }).then((result)=>{
                    if(result.isConfirmed){
                        $.post('@Url.Action("Eliminar", "Carrito", new { area = "Negocio" })', {productoId: productoId}, function(){
                            row.remove();
                            actualizarTotal();
                            actualizarBadge();
                            actualizarVistaCarrito();
                            Swal.fire({icon:'success', title:'Producto eliminado', timer:1000, showConfirmButton:false});
                        });
                    }
                });
            });

            $('#vaciar-carrito').click(function(){
                Swal.fire({
                    title:'Vaciar carrito',
                    text:'¿Deseas vaciar todo el carrito?',
                    icon:'warning',
                    showCancelButton:true,
                    confirmButtonText:'Sí',
                    cancelButtonText:'Cancelar'
                }).then((result)=>{
                    if(result.isConfirmed){
                        $.post('@Url.Action("Vaciar", "Carrito", new { area = "Negocio" })', function(){
                            $('#carrito-body').empty();
                            actualizarTotal();
                            actualizarBadge();
                            actualizarVistaCarrito();
                            Swal.fire({icon:'success', title:'Carrito vaciado', timer:1000, showConfirmButton:false});
                        });
                    }
                });
            });

        });
    </script>
}
