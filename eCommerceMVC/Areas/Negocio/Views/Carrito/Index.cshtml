@model IEnumerable<eCommerce.Entities.ViewModels.CarritoViewModel>

@{
    Layout = "~/Areas/Negocio/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Carrito de Compras";
}

<div class="container py-5">
    <div class="mb-4">
        <h2 class="fw-bolder" style="color: #667eea;">
            <i class="bi bi-cart3 me-2"></i>Tu Carrito
        </h2>
    </div>

    <div class="table-responsive" id="carrito-container" @(Model.Any() ? "" : "style='display:none;'")>
        <table class="table table-bordered align-middle text-center shadow-sm" id="carrito-table">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="carrito-body">
                @foreach (var item in Model)
                {
                    <tr data-producto="@item.IdProducto">
                        <td class="text-start">
                            <img src="@(item.RutaImagen ?? "https://dummyimage.com/80x80/dee2e6/6c757d.jpg")"
                                 alt="@item.Nombre" class="img-thumbnail me-2" style="width:80px; height:80px; object-fit:cover;">
                            @item.Nombre
                        </td>
                        <td class="fw-semibold">$@item.Precio?.ToString("N2")</td>
                        <td class="fw-semibold">@item.Cantidad</td>
                        <td class="subtotal fw-bold" style="color: #667eea;">$@item.Subtotal.ToString("N2")</td>
                        <td>
                            <button class="btn btn-danger btn-sm eliminar-producto">
                                <i class="bi bi-trash me-1"></i>Eliminar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr class="table-light">
                    <th colspan="3" class="text-end fs-5">Total:</th>
                    <th id="total" class="fs-5" style="color: #667eea;">$0.00</th>
                    <th>
                        <button id="vaciar-carrito" class="btn btn-warning btn-sm">
                            <i class="bi bi-trash3 me-1"></i>Vaciar carrito
                        </button>
                    </th>
                </tr>
            </tfoot>
        </table>

        <div class="mt-4 d-flex gap-2 justify-content-end">
            <a href="@Url.Action("Index", "Catalogo", new { area = "Negocio" })" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Seguir comprando
            </a>
            @Html.ActionLink("Finalizar Compra", "Index", "Checkout", new { area = "Negocio" }, new { @class = "btn btn-custom" })
        </div>
    </div>
</div>

<style>
    .btn-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        transition: all 0.3s ease;
    }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }

    .table {
        border-radius: 8px;
        overflow: hidden;
    }

        .table thead th {
            border: none;
        }
</style>

@section Scripts {
    <script>
        $(document).ready(function(){

            function parseARNumber(str){
                return parseFloat(str.replace(/\./g,'').replace(',', '.')) || 0;
            }

            function actualizarTotal(){
                let total = 0;
                $('#carrito-body tr').each(function(){
                    let subtotalStr = $(this).find('.subtotal').text().replace('$','').trim();
                    let subtotal = parseARNumber(subtotalStr);
                    total += subtotal;
                });
                $('#total').text('$' + total.toLocaleString('es-AR', {minimumFractionDigits:2}));
            }

            function actualizarBadge(){
                $.get('@Url.Action("Cantidad", "Carrito", new { area = "Negocio" })', function(total){
                    $('#carrito-badge').text(total);
                });
            }

            function actualizarVistaCarrito(){
                if($('#carrito-body tr').length === 0){
                    $('#carrito-container').hide();
                    if($('#carrito-vacio').length === 0){
                        $('.container.py-5').append(`
                            <div id="carrito-vacio" class="text-center py-5">
                                <div class="mb-4">
                                    <i class="bi bi-cart-x" style="font-size: 5rem; color: #667eea;"></i>
                                </div>
                                <h3 class="mb-3">Tu carrito está vacío</h3>
                                <p class="text-muted mb-4">¡Empezá a agregar productos para comenzar tu compra!</p>
                                <a href='@Url.Action("Index", "Catalogo", new { area = "Negocio" })' class="btn btn-custom">
                                    <i class="bi bi-shop me-2"></i>Ir al catálogo
                                </a>
                            </div>
                        `);
                    }
                }
            }

            actualizarTotal();
            actualizarBadge();
            actualizarVistaCarrito();

            $('.eliminar-producto').click(function(){
                let row = $(this).closest('tr');
                let productoId = row.data('producto');

                Swal.fire({
                    title:'Eliminar producto',
                    text:'¿Deseas eliminar este producto del carrito?',
                    icon:'warning',
                    showCancelButton:true,
                    confirmButtonColor: '#667eea',
                    confirmButtonText:'Sí, eliminar',
                    cancelButtonText:'Cancelar'
                }).then((result)=>{
                    if(result.isConfirmed){
                        $.post('@Url.Action("Eliminar", "Carrito", new { area = "Negocio" })', {productoId: productoId}, function(){
                            row.remove();
                            actualizarTotal();
                            actualizarBadge();
                            actualizarVistaCarrito();
                            Swal.fire({icon:'success', title:'Producto eliminado', timer:1500, showConfirmButton:false});
                        });
                    }
                });
            });

            $('#vaciar-carrito').click(function(){
                Swal.fire({
                    title:'Vaciar carrito',
                    text:'¿Deseas vaciar todo el carrito?',
                    icon:'warning',
                    showCancelButton:true,
                    confirmButtonColor: '#667eea',
                    confirmButtonText:'Sí, vaciar',
                    cancelButtonText:'Cancelar'
                }).then((result)=>{
                    if(result.isConfirmed){
                        $.post('@Url.Action("Vaciar", "Carrito", new { area = "Negocio" })', function(){
                            $('#carrito-body').empty();
                            actualizarTotal();
                            actualizarBadge();
                            actualizarVistaCarrito();
                            Swal.fire({icon:'success', title:'Carrito vaciado', timer:1500, showConfirmButton:false});
                        });
                    }
                });
            });

        });
    </script>
}